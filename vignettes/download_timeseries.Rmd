---
title: "Download time series from Waterinfo.be"
author: "Stijn Van Hoey"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{downloading}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
library(dplyr)
```

## Introduction

The [waterinfo.be](https://www.waterinfo.be) API uses a system of identifiers, called `ts_id` to define individual time series. For example, the identifier `ts_id` = `78073042` corresponds to the time series of air pressure data for the measurement station in Liedekerke, with a 15 min time resolution. Hence, the `ts_id` identifier defines a variable of interest from a measurement station of interest with a specific frequency (e.g. 15 min, hourly,...). The knowledge of the proper identifier is essential to be able to download the corresponding data.

```{r load_lib, echo = FALSE}
library(wateRinfo)
```


## Downloading with known `ts` identifier

In case you already know the `ts_id` identifier that defines your time serie, the package provides the function `get_timeseries_tsid` to download a specific period of the time series. 

As an example, to download the air pressure time series data of Liedekerke with a 15 min resolution (`ts_id` = `78073042`) for the first of January 2016:

```{r tsdownload}
my_data <- get_timeseries_tsid("78073042", from = "2016-01-01", to = "2016-01-02")
knitr::kable(head(my_data), align = "lcc")
```

For more information on defining the period of the download, a separate vignette is available. Let's have a visual check of our data, using the `ggplot2` package:

```{r tsvisual, fig.width = 7}
library(ggplot2)

ggplot(my_data, aes(Timestamp, Value)) + 
    geom_line()
```

## Search identifier based on variable name

For a number of variables, the [documentation of the Waterinfo.be API](https://www.waterinfo.be/download/9f5ee0c9-dafa-46de-958b-7cac46eb8c23?dl=0) provides a direct overview option of all available VMM measurement stations, using the so-called `Timeseriesgroup_id`. For these variables, the package provides the function `get_stations` to download an overview of available measurement stations and the related `ts_id` identifiers. The latter can be used to [download the time series](#Downloading-with-known-ts-identifier). 

```{r statofvar}
library('kableExtra')
library('knitr')
get_stations("air_pressure") %>%
    kable("html") %>%
    scroll_box(width = "700px", height = "300px")
```

By default, the expected frequency is the 15 min frequency of the time series. However, for some of the variables, multiple frequencies are supported by the API. The package provides the functionalities to check which variables and frequencies are supported. An overview of the currently supported variables can be requested with the command `supported_variables`. Actually, more variables are available with the API (see next section), but for each of these variables the `get_stations` function is supported (i.e. the `Timeseriesgroup_id` is documented by VMM). 

```{r suppvar}
supported_variables("en") %>% 
    as.list()
```

To check which predefined frequencies are provided by the Waterinfo.be API, the `supported_frequencies` function is available:
```{r suppfreq1}
supported_frequencies(variable_name = "air_pressure")
```

Hence, for air_pressure, only the 15 min resolution is supported. Compared to evaporation derived by [Monteith equation](https://en.wikipedia.org/wiki/Penman%E2%80%93Monteith_equation):

```{r suppfreq2}
supported_frequencies(variable_name = "evaporation_monteith")
```

multiple resolutions are available. Using the coarser time resolutions can be helpful when you want to download longer time series while keeping the number of records to download low (if the frequency would be sufficient for your analysis).


```{r statofvarwithfreq}
stations <- get_stations("evaporation_monteith", frequency = "year")
subset_of_columns <- stations %>% select(ts_id, station_no, station_name, 
                                         parametertype_name, ts_unitsymbol)
knitr::kable(subset_of_columns)
```

When interesed in the data of `Herentals_ME`, we can use the corresponding `ts_id` to download the time series of PET with a yearly frequency:

```{r yearly_pet, fig.width = 7}
pet_yearly <- get_timeseries_tsid("94526042", period = "P10Y")
pet_yearly %>% 
    na.omit() %>%
    ggplot(aes(Timestamp, Value)) + 
    geom_bar(stat = "identity") +
    scale_x_datetime(date_labels = "%Y", date_breaks = "1 year") + 
    xlab("") + ylab("PET Herentals (mm)")
```

**Remark:** this option only works for those measurement stations belonging to the VMM `meetnet` (network), related to the so-called `datasource = 1`. For [other networks](http://www.waterinfo.be/default.aspx?path=NL/HIC/Recent_toelichting), i.e. `datasource = 2`, the enlisting is not supported. Still, a search for data is provided starting from a given station name (next section).

## Search identifier based on station name

Apart from the option to check the measurement stations that can provide data for a given variable, the package provides the function `get_variables` to get an overview of the available variables for a given station, using the `station_no`. The advantage compared to the `ts_id` is that these `station_no` names are provided by the waterinfo.be website itself when exploring the data. When clicking on a measurement station on the map and checking the time series graph, the `station_no` is provided in the upper left corner in between brackets. 

![waterinfo_example_station_no](./waterinfo_screen.png){ width = 80% }

So, for the example in the figure, i.e. `station_no` = `zes42a-1066`, the available time series are retrieved by using the `get_variables` command:

```{r varforstat}
available_variables <- get_variables("zes42a-1066")
available_variables %>% select(ts_id, station_name, ts_name, 
                               parametertype_name)
```

The available number of variables depends on the measurement station. The representation is not standardized and depends also from the type of [`meetnet`](http://www.waterinfo.be/default.aspx?path=NL/HIC/Recent_toelichting). Nevertheless, one can derive the required `ts_id` from the list when interpreting the field names. Remark that the datasource can be 2 instead of 1 for specific `meetnetten` (networks). This is printed when asking the variables for a station.

In order to download the 10 min time series water level data for the station in Sint-Amands tij/Zeeschelde, the `ts_id` = `2810011` can be used in the `get_timeseries_tsid` function:

```{r downloadstamands, fig.width = 7}
tide_stamands <- get_timeseries_tsid("2810011", 
                                     from = "2017-06-01", to = "2017-06-05",
                                     datasource = 2)
ggplot(tide_stamands, aes(Timestamp, Value)) + 
    geom_line() + xlab("") + ylab("waterlevel")
```



